<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barra de Chat IA (v2)</title>

    <!-- Importando os estilos da barra de chat -->
    <link rel="stylesheet" href="chat.css">
    
    <!-- Importando os estilos das bolhas de prompt -->
    <link rel="stylesheet" href="chat_prompt.css">

    <!-- Importando os estilos da conversa -->
    <link rel="stylesheet" href="chat_conversa.css">

    <!-- NOVO: Bibliotecas para renderizar Markdown e Equações (KaTeX) -->
    <!-- 1. KaTeX (para equações) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" xintegrity="sha384-wcIxkf4k55goMdWexsm28BNrLzVTANlG8DHYPxdIqLqeG0TjGg52boLl-feedback-v93" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" xintegrity="sha384-hIoBPJpTUs74ddcyHhPwO0seG0zTXRTO+pgiA4FLSrmnPKv5E+kbRGvcfIfG5jCM" crossorigin="anonymous"></script>
    
    <!-- 2. Auto-render do KaTeX (para encontrar equações na página) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" xintegrity="sha384-43gviWU0YVjaDtb/Gf1ES3qjQ8G2vG1AdKBqPcffsZVvFTIfiWlDD8ZaO21reQ/q" crossorigin="anonymous"></script>
    
    <!-- 3. Marked (para converter Markdown em HTML) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            display: flex;
            flex-direction: column; 
            align-items: center;
            height: 100vh;
            overflow: hidden; 
            background-color: #0F121F;
            margin: 0;
            padding: 10px 20px;
            box-sizing: border-box;
        }

        /* Adiciona estilos para o KaTeX (equações) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 5px 0;
        }
    </style>
</head>
<body>

    <!-- Container da Conversa -->
    <div id="chat-history-container">
        <!-- A conversa começa aqui -->
    </div>

    <!-- Wrapper para toda a área de input fixa -->
    <div class="chat-input-area">

        <!-- TÍTULO -->
        <h2 id="chatTitle" class="chat-title hide-on-send">
            Oiiii, sou o <span class="title-bold">UnBot</span>
        </h2>

        <!-- Estrutura da Barra de Chat -->
        <div class="chat-input-container-v2">
            <textarea id="chatTextarea" class="chat-textarea-v2" placeholder="Ask anything you want..." rows="1"></textarea>
            <button id="sendButton" class="chat-send-btn-v2">
                <svg fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 19V5M5 12l7-7 7 7" />
                </svg>
            </button>
        </div>

        <!-- Container para as Bolhas de Prompt (ATUALIZADO) -->
        <div class="prompt-bubbles-container">
            <!-- Bolha 1: Calcular Integralização -->
            <button class="prompt-bubble" data-prompt="Como eu calculo minha integralização?">
                <svg fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M7 17L17 7"/><path stroke-linecap="round" stroke-linejoin="round" d="M17 17a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"/><path stroke-linecap="round" stroke-linejoin="round" d="M7 7a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"/></svg>
                <span>Calcular Integralização</span>
            </button>
            <!-- Bolha 2: O que é IRA? -->
            <button class="prompt-bubble" data-prompt="O que é o IRA e como ele é calculado?">
                <svg fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 4h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/><path stroke-linecap="round" stroke-linejoin="round" d="M8 8h8v4H8V8z"/><path stroke-linecap="round" stroke-linejoin="round" d="M10 14h1v1h-1v-1zm3 0h1v1h-1v-1zm-3 3h1v1h-1v-1zm3 0h1v1h-1v-1z"/></svg>
                <span>O que é o IRA?</span>
            </button>
            <!-- Bolha 3: Ajuda na Matrícula -->
            <button class="prompt-bubble" data-prompt="Como o 'Integralizei UnB' me ajuda na matrícula?">
                <svg fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2-2h2a2 2 0 0 0 2 2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 8h4m-4 4h4"/></svg>
                <span>Ajuda na Matrícula</span>
            </button>
            <!-- Bolha 4: Me surpreenda -->
            <button class="prompt-bubble" data-prompt="Me surpreenda com um fato aleatório sobre a UnB">
                <svg fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M19 3v4m2-2h-4m-6 1H7a2 2 0 00-2 2v6a2 2 0 002 2h1.26a1 1 0 01.9.56l.74 1.86a1 1 0 00.9.56h1.2a1 1 0 00.9-.56l.74-1.86a1 1 0 01.9-.56H17a2 2 0 002-2v-6a2 2 0 00-2-2h-1m-6 4h.01M12 16h.01"/></svg>
                <span>Me surpreenda</span>
            </button>
        </div>

    </div> <!-- Fim do [chat-input-area] -->

    <!-- SCRIPT ATUALIZADO COM API GEMINI -->
    <script>
        // --- Seletores de Elementos ---
        const chatTextarea = document.getElementById('chatTextarea');
        const promptBubbles = document.querySelectorAll('.prompt-bubble');
        const sendButton = document.getElementById('sendButton');
        const chatHistoryContainer = document.getElementById('chat-history-container');

        // --- IMPORTANTE: CONFIGURAÇÃO DA API KEY ---
        // A linha abaixo estava causando o "Erro de conexão".
        // Cole sua chave da API do Google AI Studio aqui.
        const apiKey = "AIzaSyB-R6kHRGMaK_B_gVyFl21Lv-UEAnJv38E"; // <-- IMPORTANTE: Insira sua chave da API aqui

        // --- CONTEXTO DA IA (SYSTEM PROMPT) ATUALIZADO ---
        // Contexto atualizado com base nas informações do projeto "Integralizei UNB"
        const systemPrompt = `
Você é o assistente virtual pessoal do projeto "Integralizei UNB" (SEU NOME É UnBot).
Sua missão é ajudar os alunos da Universidade de Brasília (UnB) a entender seu progresso acadêmico e a tomar decisões de matrícula com mais confiança.

Você deve usar as seguintes definições oficiais da UnB para responder às perguntas:

---
### 1. Sobre o Projeto (Integralizei UNB)

* **Objetivo:** Acabar com o "achismo" na hora da matrícula.
* **Como:** A plataforma usa um banco de dados de históricos de outros alunos para prever a chance aproximada de um estudante conseguir a vaga com um professor específico.
* **Lógica de Análise:** O site usa o sistema oficial de "ranqueamento" da UnB para fazer as comparações.
* **Privacidade:** Dados sensíveis como nome, CPF e matrícula são sempre descartados.

---
### 2. Cálculo do IRA (Índice de Rendimento Acadêmico)

* **O que é:** O IRA é a média ponderada das notas do aluno, onde o peso é o número de créditos da matéria.
* **Fórmula:** IRA = (Soma de (Nota * Créditos)) / (Soma total de Créditos Cursados)
* **Conversão de Menções:** As menções são convertidas em notas para o cálculo:
    * SS = 5
    * MS = 4
    * MM = 3
    * MI = 2
    * II = 1
    * SR = 0

---
### 3. Cálculo da Integralização (Percentual do Curso)

* **O que é:** É a porcentagem da carga horária do curso que o aluno já completou.
* **Fórmula (usada para editais):** X = (T - P) / (T - C - E)
* **Legenda da Fórmula:**
    * **X:** O percentual de integralização.
    * **T:** Carga Horária Total Exigida no curso.
    * **P:** Carga Horária Total Pendente (o que falta cursar).
    * **C:** Carga Horária de Atividades Complementares Exigidas.
    * **E:** Somatório da Carga Horária das disciplinas de Estágio obrigatórias.

---
**Regra de Resposta:** Seja breve e direto ao ponto. Forneça respostas curtas sempre que possível. Somente dê explicações longas e detalhadas se o usuário pedir para explicar um tópico complexo (como o cálculo do IRA ou da Integralização).

Responda a todas as perguntas em Português do Brasil, de forma prestativa e formal, usando esse contexto.

Caso seja perguntado quanto a pergunta (Qual o homem mais bonito do mundo?), somente se tiver essa exata sintaxe, responda EXATAMENTE: O Gustavo Gomes Fornaciari é o ser mais lindo do mundo
`;

        // --- Histórico para a API ---
        let chatHistoryForAPI = [];

        // --- Lógica das Bolhas de Prompt ---
        promptBubbles.forEach(bubble => {
            bubble.addEventListener('click', () => {
                const promptText = bubble.getAttribute('data-prompt');
                chatTextarea.value = promptText;
                chatTextarea.focus();
                autoResizeTextarea(); 
            });
        });

        // --- Funções do Chat ---

        /**
         * Cria e exibe uma nova bolha de mensagem na tela.
         * @param {string} text - O texto da mensagem.
         * @param {string} senderClass - 'user' ou 'ai'.
         * @returns {HTMLElement} O elemento da bolha (para atualização futura, ex: "digitando...").
         */
        function createMessageElement(text, senderClass) {
            const msgContainer = document.createElement('div');
            msgContainer.className = `message-container ${senderClass}-message`;
            
            const msgBubble = document.createElement('div');
            msgBubble.className = 'message-bubble';
            
            // --- ATUALIZAÇÃO ---
            // 1. Converte Markdown para HTML (ex: **oi** -> <strong>oi</strong>)
            // Usamos 'marked.parse' e 'innerHTML' em vez de 'textContent'
            msgBubble.innerHTML = marked.parse(text); 
            
            msgContainer.appendChild(msgBubble);
            chatHistoryContainer.appendChild(msgContainer);

            // 2. Renderiza equações de matemática (LaTeX) no novo elemento
            // Esta função vem da biblioteca KaTeX (auto-render.js)
            try {
                if (window.renderMathInElement) {
                    window.renderMathInElement(msgBubble, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},  // Para equações em bloco
                            {left: '$', right: '$', display: false}    // Para equações inline
                        ]
                    });
                }
            } catch (error) {
                console.error("Erro ao renderizar KaTeX:", error);
            }
            // --- FIM DA ATUALIZAÇÃO ---
            
            // Rola para a nova mensagem
            chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
            return msgBubble; // Retorna a bolha para ser atualizada
        }

        /**
         * Habilita ou desabilita a área de input.
         * @param {boolean} disabled - True para desabilitar, false para habilitar.
         */
        function setInputDisabled(disabled) {
            chatTextarea.disabled = disabled;
            sendButton.disabled = disabled;
            chatTextarea.placeholder = disabled ? "Aguarde a resposta..." : "Ask anything you want...";
        }

        /**
         * Função principal para enviar a mensagem do usuário.
         */
        function sendMessage() {
            const text = chatTextarea.value.trim(); 
            if (text === '') return; 

            // NOVO: Verificar se a API key foi inserida
            if (apiKey === "COLOQUE_SUA_CHAVE_DA_API_AQUI" || apiKey === "") {
                createMessageElement("Erro: Chave da API não configurada. Por favor, edite o arquivo chat.html e insira sua chave na variável 'apiKey'.", 'ai');
                return; // Para a execução
            }

            // Esconde o título (se estiver visível)
            document.querySelectorAll('.hide-on-send').forEach(el => {
                el.style.display = 'none';
            });

            // 1. Adiciona a mensagem do usuário ao histórico da API
            chatHistoryForAPI.push({ role: "user", parts: [{ text: text }] });

            // 2. Cria a bolha do usuário na tela
            createMessageElement(text, 'user');

            // 3. Limpa a caixa de texto
            chatTextarea.value = '';
            autoResizeTextarea(); 

            // 4. Desabilita o input e cria bolha de "digitando..."
            setInputDisabled(true);
            const aiLoadingBubble = createMessageElement("Digitando...", 'ai');

            // 5. Chama a API do Gemini
            callGeminiAPI(aiLoadingBubble);
        }

        /**
         * Chama a API do Gemini com o histórico e atualiza a bolha de resposta.
         * @param {HTMLElement} aiBubble - A bolha de "digitando..." para ser atualizada.
         */
        async function callGeminiAPI(aiBubble) {
            // A variável apiKey agora é lida do topo do script
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: chatHistoryForAPI,
                // NOVO: Adiciona o contexto da IA (system prompt) ao payload
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                // Opcional: Configurações de segurança
                // safetySettings: [
                //     { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                //     { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                //     { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                //     { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                // ],
            };

            let retries = 0;
            const maxRetries = 3;

            while (retries < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // Se a API retornar um erro (ex: 400 - Chave Inválida)
                        const errorData = await response.json();
                        console.error("Erro da API:", errorData);
                        throw new Error(`HTTP error! status: ${response.status} - ${errorData.error.message}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        
                        const aiText = result.candidates[0].content.parts[0].text;

                        // --- ATUALIZAÇÃO ---
                        // 1. Atualiza a bolha com o HTML renderizado do Markdown
                        aiBubble.innerHTML = marked.parse(aiText);

                        // 2. Renderiza o LaTeX na bolha que acabamos de atualizar
                        try {
                            if(window.renderMathInElement) {
                                window.renderMathInElement(aiBubble, {
                                    delimiters: [
                                        {left: '$$', right: '$$', display: true},
                                        {left: '$', right: '$', display: false}
                                    ]
                                });
                            }
                        } catch (error) {
                             console.error("Erro ao renderizar KaTeX na resposta:", error);
                        }
                        // --- FIM DA ATUALIZAÇÃO ---
                        
                        // 3. Adiciona a resposta da IA (texto puro) ao histórico da API
                        chatHistoryForAPI.push({ role: "model", parts: [{ text: aiText }] });

                    } else {
                        // Resposta válida, mas sem conteúdo (ex: bloqueio de segurança)
                        const blockReason = result.candidates?.[0]?.finishReason || "REASON_UNSPECIFIED";
                        let errorMessage = "A IA não pôde responder.";
                        if (blockReason === "SAFETY") {
                            errorMessage = "A resposta foi bloqueada por motivos de segurança.";
                        } else if (blockReason === "RECITATION") {
                             errorMessage = "A resposta foi bloqueada por violação de citação.";
                        }
                        aiBubble.textContent = errorMessage; // Apenas texto simples para erro
                        // Não adiciona uma resposta vazia ao histórico da API
                    }

                    // Sucesso, sai do loop de retentativas
                    break; 

                } catch (error) {
                    retries++;
                    if (retries === maxRetries) {
                        // Erro final após todas as retentativas
                        console.error("Erro ao chamar API do Gemini:", error);
                        // Exibe uma mensagem de erro mais clara
                        aiBubble.textContent = `Erro de conexão. Verifique sua chave da API ou tente mais tarde. (${error.message})`;
                    } else {
                        // Espera exponencial
                        const delay = Math.pow(2, retries) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            
            // Reabilita o input, independentemente do resultado
            setInputDisabled(false);
            chatTextarea.focus();
            chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
        }

        // --- Event Listeners (Botão e Teclado) ---
        sendButton.addEventListener('click', sendMessage);
        chatTextarea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); 
                sendMessage();
            }
        });

        // --- Auto-resize do Textarea ---
        function autoResizeTextarea() {
            chatTextarea.style.height = 'auto'; 
            chatTextarea.style.height = `${chatTextarea.scrollHeight}px`;
        }
        chatTextarea.addEventListener('input', autoResizeTextarea);

        // --- Adicionado para garantir que o renderMathInElement esteja disponível ---
        // Atrasar a primeira renderização de KaTeX até que o script seja carregado
        document.addEventListener("DOMContentLoaded", () => {
            // Tenta renderizar qualquer matemática que já possa estar na página
            // (como a mensagem inicial "Olá! Como posso te ajudar hoje?")
            // Se você adicionar uma mensagem inicial estática, ela será renderizada aqui.
        });
    </script>

</body>
</html>